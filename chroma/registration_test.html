<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FullStory Event Sandbox</title>
</head>
<body>
  <h1>FullStory Event Simulator</h1>

  <input type="file" id="csvUpload" accept=".csv" />
  <button onclick="sendFrontEndEvents()">Registration - Send Front-End Events</button>
  <button onclick="sendBackEndEvents()">Registration - Send Back-End Events</button>

  <pre id="log"></pre>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let parsedData = [];

    document.getElementById('csvUpload').addEventListener('change', function (e) {
      Papa.parse(e.target.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          parsedData = results.data;
          log('CSV loaded with ' + parsedData.length + ' rows');
        }
      });
    });

    function log(message) {
      document.getElementById('log').textContent += message + '\n';
    }

    function reformatTimestamp(rawTime) {
  if (!rawTime || !rawTime.includes(':')) return null;

  const now = new Date(); // Replace with fixed base date if needed
  const [minStr, secStr] = rawTime.split(':');
  const minutes = parseInt(minStr, 10);
  const seconds = parseFloat(secStr);

  now.setMinutes(minutes);
  now.setSeconds(Math.floor(seconds));
  now.setMilliseconds(0);

  return now.toLocaleString('en-GB'); // Format: "DD/MM/YYYY HH:mm:ss"
}

    function sendFrontEndEvents() {
      parsedData.forEach(row => {
        FS.event('Registration | Success', {
          PlayerID: row['PLAYER_ID'],
          Timestamp: row['TIMESTAMP'],
          AccountStatus: row['ACCOUNT_STATUS'],
          PlayerTier: row['PLAYER_TIER'],
          VerificationStatus: row['VERIFICATION_STATUS'],
          UTMMedium: row['CHANNEL'],
          UTMSource: row['PARTNER'],
          UTMCampaign: row['PARTNER_GROUP']
        });
        log('Front-End Event sent for Player ID: ' + row['PLAYER_ID']);
      });
    }

    // Timestamp converter: assumes raw is in MM:SS.s format
  function reformatTimestamp(rawTime) {
    if (!rawTime || !rawTime.includes(':')) return null;

    const now = new Date(); // You can set a fixed base date here if needed
    const [minStr, secStr] = rawTime.split(':');
    const minutes = parseInt(minStr, 10);
    const seconds = parseFloat(secStr);

    now.setMinutes(minutes);
    now.setSeconds(Math.floor(seconds));
    now.setMilliseconds(0);

    return now.toLocaleString('en-GB'); // Format: "DD/MM/YYYY HH:mm:ss"
  }

  function sendBackEndEvents() {
  parsedData.forEach((row, index) => {
    console.log(`Row ${index + 1}:`, row);
    console.log('Keys:', Object.keys(row));

    const playerId = row['PLAYER_ID'];
    const timestamp = reformatTimestamp(row['TIMESTAMP']);

    if (!playerId) {
      console.warn(`Row ${index + 1}: Missing PLAYER_ID`);
      return;
    }

    FS.event('Account | Registration | Success', {
      PlayerID: playerId,
      Timestamp: timestamp,
      DisplayName: row['DISPLAY_NAME'],
      UID: row['UID'],
      Domain: row['DOMAIN'],
      Language: row['LANGUAGE'],
      Country: row['COUNTRY'],
      Channel: row['CHANNEL'],
      Partner: row['PARTNER'],
      PartnerGroup: row['PARTNER_GROUP'],
      AcquisitionApplication: row['ACQUISITION_APPLICATION'],
      AcquisitionDevice: row['ACQUISITION_DEVICE'],
      AcquisitionOS: row['ACQUISITION_OS'],
      AccountStatus: row['ACCOUNT_STATUS'],
      PlayerTier: row['PLAYER_TIER'],
      VerificationStatus: row['VERIFICATION_STATUS']
    });

    console.log(`Back-End Event sent for Player ID: ${playerId}`);
  });
}
  </script>

  <!-- Make sure FullStory snippet is added to this page in your sandbox -->
  <script>
    window['_fs_debug'] = false;
    window['_fs_host'] = 'fullstory.com';
    window['_fs_script'] = 'edge.fullstory.com/s/fs.js';
    window['_fs_org'] = 'o-22YWXK-na1'; // replace with your actual FullStory Org ID
    window['_fs_namespace'] = 'FS';
    (function(m,n,e,t,l,o,g,y){
        if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
        g=m[e]=function(a,b){g.q?g.q.push([a,b]):g._api(a,b);};g.q=[];
        o=n.createElement(t);o.async=1;o.crossOrigin='anonymous';o.src='https://'+_fs_script;
        y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
        g.identify=function(i,v){g(l,{uid:i},v)};g.setUserVars=function(v){g('userVars',v)};
        g.event=function(i,v){g('event',{n:i,p:v})};
        g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
        g.consent=function(a){g("consent",!arguments.length||a)};
        g.identifyAccount=function(i,v){g("account",{acctId:i},v)};
        g.clearUserCookie=function(){};
    })(window,document,window['_fs_namespace'],'script','user');
  </script>
</body>
</html>
