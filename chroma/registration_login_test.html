<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FullStory Event Simulator</title>
</head>
<body>
  <h1>FullStory Event Simulator</h1>

  <!-- Registration Upload -->
  <h2>Upload Registration Data</h2>
  <input type="file" id="registrationCsvUpload" accept=".csv" />
  <button onclick="sendBackEndRegistrationEvents()">Send Back-End Registration Events</button>
  <br><br>


  <!-- Log Output -->
  <pre id="log"></pre>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    let registrationData = [];

    // CSV upload handlers
      document.getElementById('registrationCsvUpload').addEventListener('change', function (e) {
      Papa.parse(e.target.files[0], {
        header: true,
        skipEmptyLines: true,
        transformHeader: header => header.trim(),
        complete: function (results) {
          registrationData = results.data;
          log('✅ Registration CSV loaded with ' + registrationData.length + ' rows');
        },
        error: function (err) {
          log('❌ Error parsing registration CSV: ' + err.message);
        }
      });
    });

   document.getElementById('loginCsvUpload').addEventListener('change', function (e) {
      Papa.parse(e.target.files[0], {
        header: true,
        skipEmptyLines: true,
        transformHeader: header => header.trim(),
        complete: function (results) {
          loginData = results.data;
          log('✅ Login CSV loaded with ' + loginData.length + ' rows');
        },
        error: function (err) {
          log('❌ Error parsing login CSV: ' + err.message);
        }
      });
    });

    // Log helper
    function log(message) {
      const logBox = document.getElementById('log');
      logBox.textContent += message + '\n';
      console.log(message);
    }

    }

    // Convert TIMESTAMP (e.g., 56:28.0) into YYYY-MM-DD HH:mm:ss.000
   function formatTimestamp(rawTime) {
      if (!rawTime || !rawTime.includes(':')) return null;

      const [minStr, secStr] = rawTime.split(':');
      const minutes = parseInt(minStr, 10);
      const seconds = parseFloat(secStr);
      const baseDate = new Date('2025-05-21T10:00:00Z');

      baseDate.setMinutes(minutes);
      baseDate.setSeconds(Math.floor(seconds));
      baseDate.setMilliseconds(Math.round((seconds % 1) * 1000));

      const pad = n => n.toString().padStart(2, '0');
      const ms = baseDate.getMilliseconds().toString().padStart(3, '0');
      return `${baseDate.getFullYear()}-${pad(baseDate.getMonth() + 1)}-${pad(baseDate.getDate())} ${pad(baseDate.getHours())}:${pad(baseDate.getMinutes())}:${pad(baseDate.getSeconds())}.${ms}`;
    }

  // Send registration backend event  
 function sendBackEndEvents() {
      console.log('Back-End event function triggered');

      parsedData.forEach((row, index) => {
        console.log(`Row ${index + 1}:`, row);
        console.log('Keys:', Object.keys(row));

        const playerId = row['PLAYER_ID'];
        const timestamp = reformatTimestamp(row['TIMESTAMP']);

        if (!playerId) {
          console.warn(`Row ${index + 1}: Missing PLAYER_ID`);
          return;
        }

        try {
        FS.event('Account | Registration | Success', {
           playerId: row['PLAYER_ID'],
           timestamp: timestamp,
           displayName: row['DISPLAY_NAME'],
            uid: row['UID'],
            domain: row['DOMAIN'],
            accountStatus: row['ACCOUNT_STATUS'],
            playerTier: row['PLAYER_TIER'],
            verificationStatus: row['VERIFICATION_STATUS'],
   });

          log(`Back-End Event sent for Player ID: ${playerId}`);
        } catch (err) {
          console.error('Error sending FullStory event:', err);
        }
      });
    }
  </script>
    
  <!-- FullStory Snippet -->
  <script>
   window['_fs_debug'] = false;
    window['_fs_host'] = 'fullstory.com';
    window['_fs_script'] = 'edge.fullstory.com/s/fs.js';
    window['_fs_org'] = 'o-22YWXK-na1';  // <-- Replace this with your actual FullStory Org ID
    window['_fs_namespace'] = 'FS';
    (function(m,n,e,t,l,o,g,y){
      if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
      g=m[e]=function(a,b){g.q?g.q.push([a,b]):g._api(a,b);};g.q=[];
      o=n.createElement(t);o.async=1;o.crossOrigin='anonymous';o.src='https://'+_fs_script;
      y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
      g.identify=function(i,v){g(l,{uid:i},v)};g.setUserVars=function(v){g('userVars',v)};
      g.event=function(i,v){g('event',{n:i,p:v})};
      g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
      g.consent=function(a){g("consent",!arguments.length||a)};
      g.identifyAccount=function(i,v){g("account",{acctId:i},v)};
      g.clearUserCookie=function(){};
    })(window,document,window['_fs_namespace'],'script','user');
  </script>
</body>
</html>
