<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FullStory Event Simulator</title>
</head>
<body>
  <h1>FullStory Event Simulator</h1>

  <!-- Registration Upload -->
  <h2>Upload Registration Data</h2>
  <input type="file" id="registrationCsvUpload" accept=".csv" />
  <button id="sendEventsButton" disabled>Send Back-End Registration Events</button>
  <br><br>

  <!-- Log Output -->
  <pre id="log"></pre>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  let parsedData = [];

  function log(message) {
    const logElem = document.getElementById('log');
    logElem.textContent += message + '\n';
    console.log(message);
  }

  function formatTimestamp(rawTime) {
    if (!rawTime || !rawTime.includes(':')) return null;
    const [minStr, secStr] = rawTime.split(':');
    const minutes = parseInt(minStr, 10);
    const seconds = parseFloat(secStr);
    const baseDate = new Date('2025-05-21T10:00:00Z');

    baseDate.setMinutes(minutes);
    baseDate.setSeconds(Math.floor(seconds));
    baseDate.setMilliseconds(Math.round((seconds % 1) * 1000));

    const pad = n => n.toString().padStart(2, '0');
    const ms = baseDate.getMilliseconds().toString().padStart(3, '0');
    return `${baseDate.getFullYear()}-${pad(baseDate.getMonth() + 1)}-${pad(baseDate.getDate())} ${pad(baseDate.getHours())}:${pad(baseDate.getMinutes())}:${pad(baseDate.getSeconds())}.${ms}`;
  }

  document.getElementById('registrationCsvUpload').addEventListener('change', function (e) {
    Papa.parse(e.target.files[0], {
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        parsedData = results.data;
        log('✅ CSV loaded with ' + parsedData.length + ' rows');
      }
    });
  });

  function sendBackEndRegistrationEvents() {
    if (!window.FS || typeof FS.event !== 'function') {
      log("❌ FS is not ready or not initialized.");
      return;
    }

    parsedData.forEach((row, index) => {
      const playerId = row['PLAYER_ID'];
      const timestamp = formatTimestamp(row['TIMESTAMP']);

      if (!playerId) {
        log(`⚠️ Row ${index + 1} skipped: Missing PLAYER_ID`);
        return;
      }

      try {
        FS.event('Account | Registration | Success', {
          PlayerID: playerId,
          Timestamp: timestamp,
          DisplayName: row['DISPLAY_NAME'],
          UID: row['UID'],
          Domain: row['DOMAIN'],
          AccountStatus: row['ACCOUNT_STATUS'],
          PlayerTier: row['PLAYER_TIER'],
          VerificationStatus: row['VERIFICATION_STATUS'],
        });
        log(`✅ Event sent for Player ID: ${playerId}`);
      } catch (err) {
        log(`❌ Error sending event for Player ID: ${playerId}`);
        console.error(err);
      }
    });
  }

  // Wait for FS to be ready before enabling button
  function waitForFullStory(callback) {
    const interval = setInterval(() => {
      if (typeof FS !== 'undefined' && typeof FS.event === 'function') {
        clearInterval(interval);
        log('✅ FullStory is ready');
        document.getElementById('sendEventsButton').disabled = false;
        document.getElementById('sendEventsButton').addEventListener('click', callback);
      } else {
        console.log('⏳ Waiting for FullStory to load...');
      }
    }, 500);
  }

  waitForFullStory(sendBackEndRegistrationEvents);
</script>


  <!-- FullStory Snippet -->
  <script>
    window['_fs_debug'] = false;
    window['_fs_host'] = 'fullstory.com';
    window['_fs_script'] = 'edge.fullstory.com/s/fs.js';
    window['_fs_org'] = 'o-22YWXK-na1';  // Replace with your real FullStory Org ID
    window['_fs_namespace'] = 'FS';

    (function(m,n,e,t,l,o,g,y){
      if (e in m) return;
      g = m[e] = function(a,b){ g.q ? g.q.push([a,b]) :
